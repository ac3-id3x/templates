<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>SelogerPro - Facturation - Interface de paiement en ligne</title>
    <style type="text/css">
      .FondTitre
      {
      	background-color: #CC0001; color: white ; font-weight: bold ;
      	padding:5px 0px 0px 15px;
      }
    </style>
    <script type="text/javascript" src="/z/portail/pol/engine/espaceclient/js/easyXDM.min.js"></script>
    <script type="text/javascript">
    //<![CDATA[
        var frameHeight = 150;
        /**
        * Request the use of the JSON object
        */
        easyXDM.DomHelper.requiresJSON("/z/portail/pol/engine/espaceclient/js/json2.js");
    //]]>
    </script>
    <script type="text/javascript">
    //<![CDATA[
        var paymentResponseString = "";
        var paymentDetailedResponseString = "";

        var remoteServer = "http://onlinepaymentapi.poliris.com/"; //"http://217.151.1.28/OnlinePaymentAPI/"
        var paramUrl = "";
        var thisUrl = window.location.href;
        var canContinue = true;

        if (thisUrl.indexOf("?url=") > -1) {
            paramUrl = thisUrl.substr(thisUrl.indexOf("?url=") + 5);
        } else {
            alert('error in the process of payment. ' + thisUrl);
            canContinue = false;
        }

        if (canContinue) {
            var remote = new easyXDM.Rpc(/** The channel configuration */{
            /**
            * Register the url to hash.html, this must be an absolute path
            * or a path relative to the root.
            * @field
            */
            local: "name.html",
            /**
            * Register the url to the remote interface
            * @field : http://217.151.1.28/OnlinePaymentAPI/Faulted.aspx + http://217.151.1.28/OnlinePaymentAPI/js/name.html + http://localhost/ID3x2/js/name.html + "StartNewTransaction.aspx?IdTiers=81907&SupplierId=1&OrderRef=7&applicationId=1&amount=121"
            */
            remote: remoteServer + "PaymentHost.aspx?url=" + escape(paramUrl),
            remoteHelper: remoteServer + "js/name.html",
            /**
            * Register the DOMElement that the generated IFrame should be inserted into - border: "2px dotted red",
            */
            container: "embedded",
            props: {
                style: {
                    height: "700px",
                    width: "100%"
                }
            },
            onReady: function () {
                /**
                * Call a method on the other side
                */
                //OnunloadIframeCallback();
            }
        }, /** The interface configuration */{
        remote: {
            rPaymentResponse: {},
            rDetailedResponse: {}
        },
        local: {
            alertMessage: function (msg) {
                alert(msg);
            },
            ReportFrameSize: function (height, width) {
                frameHeight = height;
                //this.container.getElementsByTagName("iframe")[0].style.height = message + "px";
                var frame = window.document.getElementById('easyXDM_default0_provider');
                frame.style.height = frameHeight;
                window.embedded.style.height = frameHeight;
                //window.frames[0].style.height = msg + "px";
                //OnunloadIframeCallback();
            }
        }
    });
}

        function localPaymentResponse() {
            remote.rPaymentResponse(function (result) {
                paymentResponseString = result;
            }, function(errorObj) {
                // here we can react to a possible error
                alert('on error occured : ' + errorObj);
            });
        }

        function localDetailedResponse() {
            remote.rDetailedResponse(function (result) {
                paymentDetailedResponseString = result;
            });
        }

        function PaymentResponse() {
            return paymentResponseString;
        }

        function DetailedResponse() {
            return paymentDetailedResponseString;
        }
    //]]>
    </script>
    <script type="text/javascript">
    //<![CDATA[
        function OnunloadIframeCallback() {
            if (window.opener != null) {
                localPaymentResponse();
                if (paymentResponseString && (paymentResponseString != "notfound")) {
                    try {
                        window.opener.ReportPaymentResponse(paymentResponseString);
                    }
                    catch (e) { alert('erreur opener.paymentresponse : ' + e); }
                }

                localDetailedResponse();
                if (paymentDetailedResponseString && (paymentDetailedResponseString != "notfound")) {
                    try {
                        window.opener.ReportDetailedResponse(paymentDetailedResponseString);
                    }
                    catch (e) { alert('erreur opener.DetailedResponse : ' + e); }
                }
            }
        }
        
        function SendParent()
        {
        	if (opener)
        	{
        		OnunloadIframeCallback();
        		opener.RefreshParent();
        	} else {
        		alert('pas de opener');
        	}
        }
    //]]>
    </script>
</head>
<body style="margin:0px 0px 0px 0px;" onbeforeunload="SendParent();">
    <form name="form1" method="post" action="" id="form1">
        <div>
            <input type="hidden" name="__UISTATE" id="__UISTATE" value="" />
        </div>
        <div class="FondTitre">
            <b>SelogerPro - Paiement en ligne - (Interface de paiement du partenaire)</b>
        </div>
        <!-- <div id="log" style="height:100px;border:1px dotted black;overflow:auto"></div> -->
        <div id="embedded"></div>

        <script type="text/javascript">
        //<![CDATA[
            function PaymentClose() { window.close(); }
            //]]>
        </script>
    </form>
</body>
</html>
