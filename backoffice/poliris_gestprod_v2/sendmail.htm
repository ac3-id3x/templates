$$E:GDP2:DOSSIER:REP:2$$


$$E:GDP2:LECTURE_AGENCEPUBLICATION:~id:REP:2:~type:1$$
$$E:GDP2:LECTURE_INFORMATIONPRODUIT:~iddossier:REP:2$$
$$E:GDP2:LECTURE_COMMERCIAL:REP:1$$
$$E:AUTH:VERIFICATION$$
$$E:GDP2:BILAN_SUIVI_TDL:REP:1$$
$$E:GDP2:USER_INFO$$
$$INCL:POPUP_HAUT.HTM$$




<SCRIPT>

function getopener()
{
	if (window.dialogArguments)
	{
		return dialogArguments;
	}	else {
		return top.opener;
	}
}

function charge_sendmail()
{
	alert("plop");
	// Définition des champs cachés du formulaire
	formulaire = window.document.sendmail;
	
	formulaire.LECTURE_COMMERCIAL.value = "$$GDP2:LECTURE_COMMERCIAL:COM_PRENOM replace " \" $$ $$GDP2:LECTURE_COMMERCIAL:COM_NOM replace " \" $$";
	formulaire.LECTURE_COMMERCIAL_email.value = "$$GDP2:LECTURE_COMMERCIAL:COM_EMAIL replace " \" $$";
	formulaire.client_nom.value = "$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCE replace " \" $$$$IF0:GDP2:LECTURE_AGENCEPUBLICATION:AGENCE$$$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCE replace " \" $$$$END$$";
	formulaire.client_email.value = "$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCEMAIL replace " \" $$$$IF0:GDP2:LECTURE_AGENCEPUBLICATION:AGENCEMAIL$$$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCEMAIL replace " \" $$$$END$$";
	formulaire.dossier_url.value = "$$FORM:DOS_URL replace " \" $$";
	formulaire.slpro_login.value="$$GDP2:LECTURE_AGENCEPUBLICATION:REFERENCE replace " \" $$";
	formulaire.slpro_passe.value="$$GDP2:LECTURE_AGENCEPUBLICATION:MOTDEPASSE replace " \" $$";

	dossier_etat = '$$GDP2:DOSSIER:IDETATDOCUMENTS$$';
	alert(dossier_etat);
	if (dossier_etat==1)
	{
		formulaire.dossier_attente.value='2';
	}
	if (dossier_etat==3)
	{
		formulaire.dossier_attente.value='2';
	}
	if (dossier_etat==13)
	{
		formulaire.dossier_attente.value='3';
	}
}

   
function trimSpaces(targetString,trimMode) 
{
   // 0 = trim debut et fin
   // 1 = trim debut uniquement
   // 2 = trim fin uniquement
   var iPos;
   iPos=0;
   if (trimMode==0 || trimMode==1)
    {
        if (targetString.charAt(iPos)==' ')
        {
            while(targetString.charAt(iPos)==' ')
            {
                iPos++;
            }
            targetString = targetString.substr(iPos);
        }
    }
    iPos = targetString.length-1;
    if (trimMode==0 || trimMode==2)
    {
        if (targetString.charAt(iPos)==' ')
        {
            while(targetString.charAt(iPos)==' ')
            {
                iPos--;
            }
            targetString = targetString.substr(0,iPos+1);
        }
    }
    return targetString;
}

// vérifie la syntaxe du mail
function verif_mail(mail) {
      if ((mail.indexOf("@")>=0)&&(mail.indexOf(".")>=0)) 
      {return true;} 
      else {return false;}
}

function format_mail(adr)
{
	var adr = adr.split(',');
	var adr2 = '';

	//alert(adr)
	for(i = 0 ; i < adr.length ; i++)
	{
		if (i>0 && i<adr.length)
		{
			adr2 = adr2+',';
		}

		if(adr[i])
		{
			if(verif_mail(adr[i]))
			{
				adr2 = adr2+trimSpaces(adr[i],0);		
			} 
			else 
			{
				alert('L\'email ne sera pas envoyé à cette adresse :\n\r'+adr[i]+'\n\rLa syntaxe est incorrecte');
				error_mail=true;
			}
		}
	}
	adr = adr2;

	return adr;
}

function email_valid()
{
	error_mail=0;
	//var cc = formulaire.cc.value; 
	//var bcc = formulaire.bcc.value;
	var elt_cc = document.getElementById('cc');
	var elt_bcc = document.getElementById('bcc');
	var elt_com_mail = document.getElementById('LECTURE_COMMERCIAL_email');
	var elt_client_mail = document.getElementById('client_email');
	

	if (elt_cc)
	{
		//cc = format_mail(cc);
		var cc = format_mail(elt_cc.value);
		if(cc)
			elt_cc.value = cc;
		else 
			error_mail=error_mail+1;
	} 

	if (elt_bcc)
	{
		var bcc = format_mail(elt_bcc.value);
		if(bcc)
			elt_bcc.value = bcc
		else
			error_mail=error_mail+1;
	}

	if (elt_com_mail)
	{
		var com = format_mail(elt_com_mail.value);
		
		if(com) {
		//alert(com);
			elt_com_mail.value = com;
		} else {
			error_mail=error_mail+1;
		}
	}
	
	if (elt_client_mail)
	{
		var client = format_mail(elt_client_mail.value);
		if(client)
			elt_client_mail.value = client;
		else 
			error_mail=error_mail+1;
	}

	//envoi du mail
	if (parseInt(error_mail) >= 4)
	{
		/*if(confirm('Voulez-vous envoyer ce message malgrés les adresses supprimées?'))
		{formulaire.submit();}*/
		alert("Vous ne pouvez pas envoyer d'email sans mentionner au moins une adresse.");
	}
	else {
		formulaire.submit()
	}	
}

function hide_form(name)
{
	// Définition des champs cachés du formulaire
	formulaire = window.document.sendmail;
	//TypeMail = document.getElementById("cfg_emails").value;
	TypeMail = formulaire.cfg_emails.value;

	var trToHide = document.getElementsByTagName('tr');
	if(TypeMail == "sendmail_rapporttdl" || TypeMail == "sendmail_rs")
	{
	change_mail(1);
		for (i = 0; i < trToHide.length; i++) 
		{
	  		if (trToHide[i].className == "tohide")
	  		{
	    		trToHide[i].style.display = 'none';
	  		};
	  		if(TypeMail == "sendmail_rs")
	  		{
			  		if (trToHide[i].className == "tohideurl")
			  		{
			    		trToHide[i].style.display = '';
			  		};
	  	  }
	  	  else
	  	  {
			  		if (trToHide[i].className == "tohideurl")
			  		{
			    		trToHide[i].style.display = 'none';
			  		};
	  	  }
	  	};
	}
	else
	{
		
				/* FA le 09/02/2010 - Ne sert à rien. */
				//change_mail(0);
				for (i = 0; i < trToHide.length; i++) 
				{
			  		if (trToHide[i].className == "tohide")
			  		{
			    		trToHide[i].style.display = '';
			  		};
			  			if (trToHide[i].className == "tohideurl")
	  		{
	    		trToHide[i].style.display = 'none';
	  		};
			  };
	}
}



function change_mail( type_mail )
{
	if(type_mail) 
	{
		document.getElementById('bcc').value = document.getElementById('email').value;
	}
	else
	{
		document.getElementById('bcc').value  = document.getElementById('default_email').value;
		
	}
}

function getData()
{
	var myopener = getopener();
	var code_client = document.getElementById('code_client'); /* Code_client sur cette feuille */
	var myopener_code_client = myopener.document.getElementById("code_client"); /* Code_client sur le fanêtre mère */

	if(myopener_code_client) code_client.value = myopener_code_client.value;
}


function checkSiMail()
{
	var elt_com_email = document.getElementById('LECTURE_COMMERCIAL_email');
	var elt_client_email = document.getElementById('client_email');
	var elt_cc_email = document.getElementById('cc');
	var elt_bcc_email = document.getElementById('bcc');
	
	if(elt_com_email) {
		var com_email = elt_com_email.value;
	} else {
		alert("Une erreur est survenue dans la fonction javascript checkSiMail. L'élement 'LECTURE_COMMERCIAL_email est introuvable.");
		return false;
	}
	
	if(elt_client_email) {
		var client_email = elt_client_email.value;
	} else {
		alert("Une erreur est survenue dans la fonction javascript checkSiMail. L'élement 'client_email' est introuvable.");
		return false;
	}
	
	if(elt_cc_email) {
		var cc_email = elt_cc_email.value;
	} else {
		alert("Une erreur est survenue dans la fonction javascript checkSiMail. L'élement 'cc' est introuvable.");
		return false;
	}
	
	if(elt_bcc_email) {
		var bcc_email = elt_bcc_email.value;
	} else {
		alert("Une erreur est survenue dans la fonction javascript checkSiMail. L'élement 'bcc' est introuvable.");
		return false;
	}
	
	if( (com_email == '') && (client_email == '') && (cc_email == '') && (bcc_email == '') ) {
		alert("Vous devez spécifier un email");
		return false;
	}
	
}

</SCRIPT>
<style>

tr.tohide {
	visibility: visible;
}
</style>
</HEAD>

<BODY onLoad="charge_sendmail();getData(); $$IF:AUTH:VERIFICATION:COM_MAIL_TDL$$hide_form();$$END$$" >
<center><b>Changement d'Etat</b></center>

<!--<FORM action="sendmail.htm" method="post" name="sendmail"> -->
<form method="post" id="sendmail"  name="sendmail">

<table name="table" id="table" align="center">

	<input type="hidden" name="u" value="GDP2:AJOUT_HISTORIQUE_MAIL">
	<input type="hidden" name="iddossier" value="$$GDP2:DOSSIER:IDDOSSIER$$">
	<input type="hidden" name="page_ok" value="sendmail_ok.htm">
	<input type="hidden" name="page_err" value="sendmail.htm">
	<input type="hidden" name="cfg_form" value="sendmail">
	<input type="hidden" name="idetat" value="$$GDP2:DOSSIER:IDETAT$$">
	<input type="hidden" name="iduser" value="$$SESSION:IDUSER$$">
	<input type="hidden" name="dt_debut" value="$$GDP2:BILAN_SUIVI_TDL:DT_DEBUT date 2$$">
	<input type="hidden" name="impressiontotal" value="$$GDP2:BILAN_SUIVI_TDL:IMPRESSIONTOTAL$$">
	<input type="hidden" name="nb_click_commande" value="$$GDP2:BILAN_SUIVI_TDL:NB_CLICK_COMMANDE$$">
	<input type="hidden" name="nbclictotal" value="$$GDP2:BILAN_SUIVI_TDL:NBCLICTOTAL$$">
	<input type="hidden" name="txclicktotal" value="$$GDP2:BILAN_SUIVI_TDL:TXCLICKTOTAL$$">
	<input type="hidden" name="nbclicrestant" value="$$GDP2:BILAN_SUIVI_TDL:NBCLICRESTANT$$">
	<input type="hidden" name="pourcentagetotal" value="$$GDP2:BILAN_SUIVI_TDL:POURCENTAGETOTAL nbr 2$$">
	<input type="hidden" name="nbjourrestant" value="$$GDP2:BILAN_SUIVI_TDL:NBJOURRESTANT$$">
	<input type="hidden" name="clicparjour" value="$$GDP2:BILAN_SUIVI_TDL:CLICPARJOUR$$">
	
	

	<!-- Les templates des mails envoyés -->
	<input type="hidden" name="emailTemplateReçu" value="mailRecu_contact.htm" />
	<input type="hidden" name="emailTemplateEnCours" value="mailEnCours_contact.htm" />
	<input type="hidden" name="emailTemplateEnLigne" value="mailEnLigne_contact.htm" />
	<input type="hidden" name="emailTemplateTDL" value="mailTDL_contact.htm" />
	<input type="hidden" name="emailTemplateRSEnLigne" value="mailRSEnLigne_contact.htm" />

	
	<input type="hidden" name="nom" value="$$GDP2:USER_INFO:NOM ucase$$">
	<input type="hidden" name="prenom" value="$$GDP2:USER_INFO:PRENOM pcase$$">
	<input type="hidden" name="email" id="email" value="$$GDP2:USER_INFO:EMAIL$$">
	<input type="hidden" name="dos_nom" id="dos_nom" value="$$GDP2:DOSSIER:DOS_NOM$$">
	<input type="hidden" name="miseenligne" value="$$FORM:DT_MISEENLIGNE date 2$$">
	<input type="hidden" name="code_client" id="code_client" value="$$GDP2:LECTURE_INFORMATIONPRODUIT:CLI_CODE_AGENCE$$">
	$$IF=:99295:GDP2:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
		<input type="hidden" name="nom_dossier" id="nom_dossier" value="- Nom du dossier : $$GDP2:DOSSIER:DOS_NOM$$">
	$$END:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
	
	
	<tr>
		<td>
			Type de mail :
		</td>
		<td>
			$$IF!:3:REP:3$$
			<select name="cfg_emails" id="cfg_emails" OnChange="hide_form();">
				$$IF:AUTH:VERIFICATION:DOSSIER_W$$
				<option value="null" >----</option>
				<option value="sendmail_recu" >Mail de reçu</option>
				<option value="sendmail_encours" >Mail d'en cours</option>
				<option value="sendmail_enligne">Mail de mise en ligne</option>
				$$END$$
				$$IF:AUTH:VERIFICATION:COM_MAIL_TDL$$
				<option value="sendmail_rapporttdl">Mail de rapport tdl</option>
				$$END$$
				<option value="sendmail_rs">Mail de mise en ligne RS</option>
			</select>
			$$END$$
			$$IF=:3:REP:3$$
			<input type="hidden" id="vignette_termine" name="vignette_termine" value="sendmail_vignette_termine">
				Vignette terminee
			$$END$$
		</td>
	</tr>
	<tr>
		<td width="40%">Commercial : </td>
		<td><input type="text" name="LECTURE_COMMERCIAL" size="30" value="$$GDP2:LECTURE_COMMERCIAL:COM_PRENOM$$ $$GDP2:LECTURE_COMMERCIAL:COM_NOM$$" /></td>
	</tr>
	<tr>
		<td>Email commercial : </td>
		<td><input type="text" name="lecture_commercial_email" id="lecture_commercial_email" size="30" value="$$GDP2:LECTURE_COMMERCIAL:COM_EMAIL$$" /></td>
	</tr>
	<tr>
		<td>Client : </td>
		<td><input type="text" name="client_nom" size="30" value="$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCE$$"/></td>
	</tr>
	<tr>
		<td>Email Client : </td>
		<td><input type="text" name="client_email" id="client_email" size="30" value="$$GDP2:LECTURE_AGENCEPUBLICATION:AGENCEMAIL$$" /></td>
	</tr>
	<tr>
		<td>Chef de projet : </td>
		<td><input type="text" name="chefdeprojet" id="chefdeprojet" size="30" value="$$GDP2:DOSSIER:CHEFDEPROJET$$" /></td>
	</tr>
	<tr>
		<td>Email du chef de projet : </td>
		<td><input type="text" name="mail_chefdeprojet" id="mail_chefdeprojet" size="30" value="$$GDP2:DOSSIER:MAIL_CHEFDEPROJET$$" /></td>
	</tr>
	<tr>
		<td valign="top">URL : </td>
		<td><input type="text" name="dossier_url" size="30" value="$$GDP2:DOSSIER:DOS_URL$$" /></td>
	</tr>
	<tr class="tohideurl">
		<td valign="top">URL facebook : </td>
		<td><input type="text" name="dossier_url_facebook" size="30" value="$$GDP2:DOSSIER:DOS_URL_FACEBOOK$$" /></td>
	</tr>
	<tr class="tohide">
		<td valign="top">Attente : </td>
		<td><input type="text" name="dossier_attente" size="5" value="$$IF(:1,3:GDP2:DOSSIER:IDETATDOCUMENTS$$2$$END$$$$IF=:13:GDP2:DOSSIER:IDETATDOCUMENTS$$3$$END$$" > semaines</td>
	</tr>
	<tr class="tohide" >
		<td valign="top">Selogerpro : </td>
		<td class="tdRight"><label for="slpro_login">- Identifiant </label><input type="text" name="slpro_login" size="20" value="$$GDP2:LECTURE_AGENCEPUBLICATION:REFERENCE replace " \" $$" ><br><label for="slpro_passe">- Mot de passe</label> <input type="text" name="slpro_passe" size="20" value="$$GDP2:LECTURE_AGENCEPUBLICATION:MOTDEPASSE replace " \" $$" /><br/><br/></td>
	</tr>
	<tr class="tohide" >
		<td colspan="2">Commentaires</font></td>
	</tr>

	<tr class="tohide" >
		<td colspan="2"><textarea name="comment" cols="30" rows="5">$$FORM:COMMENT crlf2br$$</textarea></td>
	</tr>

	<tr class="tohide" ><td colspan="2">Adresses en copie<font size="1" color="#666666"> séparées par des virgules </font></td></tr>
	<tr class="tohide"><td colspan="2"><INPUT type="text" name="cc" id="cc" size="55" value="$$FORM:CC$$"></td></tr>
	<tr><td colspan="2">Adresses en copie carbone<font size="1" color="#666666"> séparées par des virgules </font></td></tr>
	$$IF0:GDP2:DOSSIER:COM_SI_TERRAIN$$
		<tr>
			<td colspan="4">
				$$IF!:99295:GDP2:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
					<INPUT type="text" name="bcc" id="bcc" size="55" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,webagencysav@seloger.com,marie-elise.bigot@seloger.com$$END$$$$FORM:BCC$$">
				$$END:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
				$$IF=:99295:GDP2:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
					<INPUT type="text" name="bcc" id="bcc" size="55" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,serviceclients@pericles.fr,vadelaide@pericles.fr,abrisseau@pericles.fr,webagencysav@seloger.com$$END$$$$FORM:BCC$$">
				$$END:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
			</td>
		</tr>
		<input type="hidden" name="default_email" id="default_email" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,webagencysav@seloger.com,marie-elise.bigot@seloger.com$$END$$$$FORM:BCC$$">
	$$END$$
	$$IF:GDP2:DOSSIER:COM_SI_TERRAIN$$
		<tr>
			<td colspan="2">
				$$REM$$<INPUT type="text" name="bcc" id="bcc" size="55" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,webagencysav@seloger.com,marie-elise.bigot@seloger.com$$END$$$$FORM:BCC$$">$$END$$
				$$IF!:99295:GDP2:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
					<INPUT type="text" name="bcc" id="bcc" size="55" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,webagencysav@seloger.com,marie-elise.bigot@seloger.com$$END$$$$FORM:BCC$$">
				$$END:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
				$$IF=:99295:GDP2:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
					<INPUT type="text" name="bcc" id="bcc" size="55" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,serviceclients@pericles.fr,vadelaide@pericles.fr,abrisseau@pericles.fr,webagencysav@seloger.com$$END$$$$FORM:BCC$$">
				$$END:LECTURE_INFORMATIONPRODUIT:IDCLIENT$$
			</td>
		</tr>
		<input type="hidden" name="default_email" id="default_email" value="$$IF0:FORM:BCC$$aim@seloger.com,sabrina.viot@seloger.com,webagencysav@seloger.com,marie-elise.bigot@seloger.com$$END$$$$FORM:BCC$$">
	$$END$$
	<tr><td>&nbsp;</td></tr>
	<tr><td colspan="2" align="center"><INPUT TYPE="button" value="Envoi du mail" onClick="email_valid();"> </td></tr>

</table>
</form>

$$INCL:POPUP_BAS.HTM$$