function init_TabData(){
	//Lien les icones sur la carte
	TabData['poi_aeroport'] = {text: "aéroprts", nb: 0, icon: dossierIcon+'/Pin_Aeroport_01.png'};
	TabData['poi_bus'] = {text: "bus", nb: 0, icon: dossierIcon+'/Pin_Bus_01.png'};
	TabData['poi_autolib'] = {text: "autolib'", nb: 0, icon: dossierIcon+'/Pin_Autolib_01.png'};
	TabData['poi_gare_ferroviaire'] = {text: "gares ferroviaires", nb: 0, icon: dossierIcon+'/Pin_Gare-RER_01.png'};
	TabData['poi_location_velo'] = {text: "locations de vélo", nb: 0, icon: dossierIcon+'/Pin_Velo_01.png'};
	TabData['poi_metro'] = {text: "métros", nb: 0, icon: dossierIcon+'/Pin_Metro_01.png'};
	TabData['poi_parking'] = {text: "parkings", nb: 0, icon: dossierIcon+'/Pin_Parking_01.png'};
	TabData['poi_parking_velo'] = {text: "parkings à vélo", nb: 0, icon: dossierIcon+'/Pin_ParkingVelo_01.png'};
	TabData['poi_rer'] = {text: "rer", nb: 0, icon: dossierIcon+'/Pin_Gare-RER_01.png'};
	TabData['poi_taxi'] = {text: "stations de taxi", nb: 0, icon: dossierIcon+'/Pin_Taxi_01.png'};
	TabData['poi_essence'] = {text: "pompes à essence", nb: 0, icon: dossierIcon+'/Pin_StationService_01.png'};
	TabData['poi_ferry'] = {text: "terminaux de ferry", nb: 0, icon: dossierIcon+'/Pin_Ferry_01.png'};
	TabData['poi_tramway'] = {text: "tramways", nb: 0, icon: dossierIcon+'/Pin_Tram_01.png'};
	TabData['poi_velib'] = {text: "vélib'", nb: 0, icon: dossierIcon+'/Pin_Velib_01.png'};
	TabData['poi_banque'] = {text: "banques", nb: 0, icon: dossierIcon+'/Pin_Banque_01.png'};
	TabData['poi_bar'] = {text: "bars", nb: 0, icon: dossierIcon+'/Pin_Bar_01.png'};
	TabData['poi_boucherie'] = {text: "bouchers", nb: 0, icon: dossierIcon+'/Pin_Boucher_01.png'};
	TabData['poi_boulangerie'] = {text: "boulangeries", nb: 0, icon: dossierIcon+'/Pin_Boulangerie_01.png'};
	TabData['poi_poste'] = {text: "bureaux de poste", nb: 0, icon: dossierIcon+'/Pin_BureauPoste_01.png'};
	TabData['poi_marche'] = {text: "marchés de quartier", nb: 0, icon: dossierIcon+'/Pin_Marche_01.png'};
	TabData['poi_presse_tabac'] = {text: "maisons de presse et tabac", nb: 0, icon: dossierIcon+'/Pin_Presse_01.png'};
	TabData['poi_restaurant'] = {text: "restaurants", nb: 0, icon: dossierIcon+'/Pin_Restaurant_01.png'};
	TabData['poi_superette'] = {text: "supérettes", nb: 0, icon: dossierIcon+'/Pin_Superette_01.png'};
	TabData['poi_super_hyper'] = {text: "supermarchés et hypermarchés", nb: 0, icon: dossierIcon+'/Pin_Supermarche_01.png'};
	TabData['poi_bibliotheque'] = {text: "bibliothèques", nb: 0, icon: dossierIcon+'/Pin_Bibliotheque_01.png'};
	TabData['poi_monument'] = {text: "monuments historique", nb: 0, icon: dossierIcon+'/Pin_Monument_01.png'};
	TabData['poi_theatre'] = {text: "théâtres", nb: 0, icon: dossierIcon+'/Pin_Theatre_01.png'};
	TabData['poi_casino'] = {text: "casinos", nb: 0, icon: dossierIcon+'/Pin_Casino_01.png'};
	TabData['poi_cinema'] = {text: "cinémas", nb: 0, icon: dossierIcon+'/Pin_Cinema_01.png'};
	TabData['poi_parc'] = {text: "parcs, jardins et squares", nb: 0, icon: dossierIcon+'/Pin_Parc_01.png'};
	//TabData['poi_plage'] = {text: "plages et baignades", nb: 0, icon: dossierIcon+'/Pin_piscine_01.png'};
	TabData['poi_sport'] = {text: "lieux de sport", nb: 0, icon: dossierIcon+'/Pin_Sport_01.png'};
	
	TabData['poi_college'] = {text: "collèges", nb: 0, icon: dossierIcon+'/Pin_Education_01.png'};
	TabData['poi_maternelle'] = {text: "écoles maternelles", nb: 0, icon: dossierIcon+'/Pin_Education_01.png'};
	TabData['poi_primaire'] = {text: "écoles primaires", nb: 0, icon: dossierIcon+'/Pin_Education_01.png'};
	TabData['poi_ens_superieur'] = {text: "lieux d'enseignement supérieur", nb: 0, icon: dossierIcon+'/Pin_Education_01.png'};
	TabData['poi_lycee'] = {text: "lycées", nb: 0, icon: dossierIcon+'/Pin_Education_01.png'};
	
	TabData['poi_camping'] = {text: "camping", nb: 0, icon: dossierIcon+'/Pin_Camping_01.png'};
	TabData['poi_hotel'] = {text: "hôtels", nb: 0, icon: dossierIcon+'/Pin_Hotel_01.png'};
	TabData['poi_tourisme'] = {text: "résidences de tourisme, villages et parcs", nb: 0, icon: dossierIcon+'/Pin_PointdeVue_01.png'};
	TabData['poi_hopital'] = {text: "hôpitaux", nb: 0, icon: dossierIcon+'/Pin_Hopital_01.png'};
	TabData['poi_med_generaliste'] = {text: "médecins généralistes", nb: 0, icon: dossierIcon+'/Pin_Medecin_01.png'};
	TabData['poi_med_specialiste'] = {text: "médecins spécialistes", nb: 0, icon: dossierIcon+'/Pin_Medecin_01.png'};
	TabData['poi_pharmacie'] = {text: "pharmacies", nb: 0, icon: dossierIcon+'/Pin_Pharmacie_01.png'};
	TabData['poi_creche'] = {text: "crèches", nb: 0, icon: dossierIcon+'/Pin_Creche_01.png'};
	TabData['poi_ludotheque'] = {text: "ludothèques", nb: 0, icon: dossierIcon+'/Pin_Ludotheque_01.png'};
	TabData['poi_caf'] = {text: "Caf", nb: 0, icon: dossierIcon+'/Pin_Services_Publiques_loi_01.png'};
	TabData['poi_cpam'] = {text: "Cpam", nb: 0, icon: dossierIcon+'/Pin_Services_Publiques_loi_01.png'};
	TabData['poi_gendarmerie'] = {text: "gendarmeries", nb: 0, icon: dossierIcon+'/Pin_Gendarmerie_01.png'};
	TabData['poi_mairie'] = {text: "mairies", nb: 0, icon: dossierIcon+'/Pin_Mairie_01.png'};
	TabData['poi_pole_emploi'] = {text: "pôles emploi", nb: 0, icon: dossierIcon+'/Pin_Services_Publiques_loi_01.png'};
	TabData['poi_police'] = {text: "poste de police", nb: 0, icon: dossierIcon+'/Pin_police_01.png'};
	TabData['poi_impot_entreprise'] = {text: "impôts des entreprises", nb: 0, icon: dossierIcon+'/Pin_Services_Publiques_loi_01.png'};
	TabData['poi_impot_particulier'] = {text: "impôts des particuliers", nb: 0, icon: dossierIcon+'/Pin_Services_Publiques_loi_01.png'};
}

//Vide le tableau de marqueurs
function init_TabMarker(){
	TabDataMarker = new Array();
}

//Fonction qui recalcul les données lors d'un changement de zoom, d'un déplacement et au premier chargement
function refresh_DATA(){
	nettoie_carte();
	init_TabMarker();
	get_POI(null, null, 1);//On met à jour le nombre de POI
	var Selection = $( "input[name=chk_poi]:checked");
	var schaineSousCat = '';
	var schaineCat = '';
	Selection.each(function(){
		var Value = this.value;
		Value = Value.split('|');
		id_picto = this.id.substring(4);
		if(Value[1] != ''){//Si la checkbox appartient à une sous catégorie
			schaineSousCat += Value[1]+',';
		}
		else{//Si la sous catégorie appartient à une catégorie
			schaineCat += Value[0]+',';
		}
	});
	schaineSousCat = schaineSousCat.substring(0,schaineSousCat.length - 1);
	schaineCat = schaineCat.substring(0,schaineCat.length - 1);
	// alert(schaine);
	// alert(schaineCat);
	if(schaineSousCat != ''){//A partir du moment où une checkbox de sous catégorie a été séléctionné alors cela implique que l'on n'est pas dans l'interface 3 et que même si un catégorie a été séléctionnée alors les sous catégories associées le sont aussi...
		get_POI("", schaineSousCat);
	}
	else if(schaineCat  != ''){//Pour l'interface 3
		get_POI(schaineCat,"");
	}
}

// fonction d'appel au serveur pour récupérer les POI désirés
function get_POI(id_theme_1, id_theme_2, recup_nombre_poi = 0){
	// récupération des contours de la carte
	var oLatLngBounds = map.getBounds();
	var oLatLngNorthEast = oLatLngBounds.getNorthEast();
	var oLatLngSouthWest = oLatLngBounds.getSouthWest();
	var url = '/poi,recuperationPOI.htm';

	var Request = $.ajax({
		url : url,
		type: "GET",
		dataType : 'text',
		data : {theme: id_theme_1, theme2: id_theme_2, max_lon: oLatLngNorthEast.lng(), min_lon: oLatLngSouthWest.lng(), max_lat: oLatLngNorthEast.lat(), min_lat: oLatLngSouthWest.lat(), format: 'json', cpt: recup_nombre_poi},
	})
	
	Request.done(function(data){//Si la requête est un succès
		infos = JSON.parse(data);

		if(recup_nombre_poi != 0){
			actualisation_nombre_POI(infos);
		}
		else if(id_theme_1 != ''){
			separePOI(infos, id_theme_1);
		}
		else if(id_theme_2 != ''){
			separePOI(infos);
		}
		//Permet de réafficher l'infobulle du markeur si celui-ci est encore affiché à l'écran
		if(idLastMarker != null && recup_nombre_poi == 0){
			actualiseInfoBulle();
		}
	});
	
	Request.fail(function(jqXHR, textStatus){
		alert('erreur : '+textStatus);//data - response from server
	});
}

// fonction de création d'un marker GoogleMaps
function creation_Marker(infos, id_picto){
	TabDataMarker["c_"+id_picto] = [];
	for(var i=0; i<infos.length; i++){
		// pour chaque élément retourné on récupère ses propriétés
		var oObjet = infos[i];
		var oPosition = new google.maps.LatLng(oObjet.lat, oObjet.lon);
		var sTitre = oObjet.nom+'\n'+oObjet.theme_2;
		
		// on créé le marker
		var oMarker = new google.maps.Marker({
			icon: TabData[id_picto].icon,
			position: oPosition,
			map: map,
			visible: true,
			title: sTitre
		});
		
		//On prépare le contenu de l'info bulle
		if(bAvecInfo){
			var sAffichage = '<div class="styleInfoWindow">'+oObjet.nom+'</br>'+oObjet.theme_2;
			if($.trim(oObjet.info_1) != '') sAffichage += '</br>'+oObjet.info_1;
			if($.trim(oObjet.info_2) != '') sAffichage += '</br>'+oObjet.info_2;
			if($.trim(oObjet.info_3) != '') sAffichage += '</br>'+oObjet.info_3;
			if($.trim(oObjet.info_4) != '') sAffichage += '</br>'+oObjet.info_4;
			sAffichage += '</div>';
			oMarker.Affichage = sAffichage;
		}else{
			oMarker.Affichage = '<div class="styleInfoWindow">'+oObjet.nom+'</br>'+oObjet.theme_2+'</div>';
		}

		oMarker.idPoi = oObjet.id
		
		//On se met à l'écoute des clics pour afficher des infos
		handler(oMarker);
		
		// on stocke le type du marker (quel type de POI) pouvoir les effacer selon type
		oMarker.sType = id_picto;
		// on stocke le marker dans un tableau global afin de pouvoir les effacer
		TabDataMarker["c_"+id_picto][i] = oMarker;
	}
	
	return infos.length;
}

//Fonction qui affiche les info du POI lors d'un clic
function handler(oMarker){
	google.maps.event.addListener(oMarker,'click', function() {
		if(infowindow){
			infowindow.close();
		}
		
		//On définit l'info window
		infowindow = new google.maps.InfoWindow({
			content: oMarker.Affichage,
			disableAutoPan: true
		});
		
		infowindow.open(map, oMarker);
		google.maps.event.addListener(infowindow, 'closeclick', closeMarker);
		idLastMarker = oMarker.idPoi;
	});
}

function closeMarker(){
	idLastMarker = null;
}

function actualiseInfoBulle(){
	// alert("LAST = "+idLastMarker.lat()+" "+idLastMarker.lng());
	for (var key in TabDataMarker){
		var j =0;
		while(TabDataMarker[key][j] != null){
			// alert(idLastMarker+ " =? " +TabDataMarker[key][j].idPoi);
			// alert("lat = "+TabDataMarker[key][j].idPoi.lat()+" long = "+ TabDataMarker[key][j].idPoi.lng());
			if(TabDataMarker[key][j].idPoi == idLastMarker && TabDataMarker[key][j].getMap() != null){
				// alert("IN");
				//On définit l'info window
				if(infowindow){
					infowindow.close();
				}
				infowindow = new google.maps.InfoWindow({
					content: TabDataMarker[key][j].Affichage,
					disableAutoPan: true
				});
				
				infowindow.open(map, TabDataMarker[key][j]);
				google.maps.event.addListener(infowindow, 'closeclick', closeMarker);
				return;
			}
			j += 1;
		}
	}
	idLastMarker = null;
}

// fonction d'appel pour mettre à jour le nombre de POI correspondant à une sous catégorie
function affiche_nouveau_nombre_POI(id_theme, nbPoi){
	$("#chk_"+id_theme).parent().find("span").text(nbPoi);
}

function actualisation_nombre_POI(infos){
	//On initialise le nombre de POI à zéro 
	$("[name='chk_poi']").parent().find("span").each(function() {
		$(this).text("0");
	});

	//On met à jour le nombre de POI
	var i = 0;
	//On classe les résultats par sous theme
	while(infos[i] != null){
		var oObjet = infos[i];
		//alert(oObjet.theme_2);
		if($("input[value=\"|"+oObjet.id_theme_2+"\"]")[0]){
			id_picto = $("input[value=\"|"+oObjet.id_theme_2+"\"]")[0].id.substring(4);
			affiche_nouveau_nombre_POI(id_picto, oObjet.cpt);
		}
		i += 1;
	}
}

// Fonction qui remplie la partie d'information de chaque sous catégorie (les info pour chaque Poi)
function affiche_detail_POI(id_picto, poiSousCat){
	infoSousCat = $("#info_"+id_picto);
	if(infoSousCat != null){
		infoSousCat.html('');//On vide le contenu des infos de la sous catégorie
		for(var i=0; i<poiSousCat.length; i++){
			$(infoSousCat).html($(infoSousCat).html() + "<div class=\"info\"><div class=\"nom\">"+poiSousCat[i].nom+"</div><div class=\"info1\">"+poiSousCat[i].info_1+"</div><div class=\"info2\">"+poiSousCat[i].info_2+"</div><div class=\"info3\">"+poiSousCat[i].info_3+"</div></div>");
		}
	}
}

//On récupère le nouveau centre de la carte
function gestionCenter(){
	oCentre = map.getCenter();
	marker.setMap(null);//Pour déplacer le marqueur au centre de la carte
	marker = new google.maps.Marker({
		position: new google.maps.LatLng(oCentre.lat(), oCentre.lng()), 
		map: map
	}); 
}

function Repaint(){
	google.maps.event.trigger(map, 'resize');
	map.setCenter(oCentre);
}

//On supprime tous les marqueurs de la carte avant de les supprimer du tableau global
// pour éviter de créer des marqueurs 'zombie'
function nettoie_carte(){
	for (var key in TabDataMarker){
		var j =0;
		while(TabDataMarker[key][j] != null){
				TabDataMarker[key][j].setMap(null);
				j += 1;
		}
	}
}

//Permet d'effacer les marqueurs d'une catégorie donnée de la carte et du tableau de POI
function nettoie_sous_categorie(nomSousCat){
	var j =0;
	if(TabDataMarker[nomSousCat]!= null){
		while(TabDataMarker[nomSousCat][j] != null){
			TabDataMarker[nomSousCat][j].setMap(null);
			j += 1;
		}
		TabDataMarker[nomSousCat] = null;
	}
}