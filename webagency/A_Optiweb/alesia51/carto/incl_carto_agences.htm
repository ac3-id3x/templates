$$B:IMMOBW:AGENCES::QRY:CP:ALIAS:AGENCESCARTO$$
$$BIF:AGENCESCARTO$$

<!-- http://dev.live.com/virtualearth/sdk/ -->
	<script type="text/javascript" src="http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.1&mkt=fr-fr"></script>
	<script type="text/javascript">
		var map = null;

		var address;
		var zip;
		var town;
		var country;
		var lat, lng;
		
		var numResults = 1;
		var index = 0;

		var tabwhere = new Array();		
		var iCurrentAddress;
		var results;
		var icon = '<img src="/img/picto_carto.gif" onerror="this.src=\'$$~$$carto/picto_carto.gif\'";/>';


         function GetMap()
         {	
            map = new VEMap('myMap');
            var LA = new VELatLong(46.37725420510028, 3.164062500000014); //France
            map.LoadMap(LA,5);
            StartFindLoc();
            
         }

		 function StartFindLoc()
     {
	
					$$DO$$
					addr = "1 ter rue Léon Bourgeois";
					tabaddress = addr.split('<br/>');/*recupere uniquement l'addresse*/
					address = tabaddress[0];
					zip = "$$AGENCESCARTO:CP$$";
					town = "$$AGENCESCARTO:VILLE$$";
					country = "$$AGENCESCARTO:PAYS$$";
					lat = "$$AGENCESCARTO:LATITUDE$$";
					lng = "$$AGENCESCARTO:LONGITUDE$$";
					idpub = "$$AGENCESCARTO:IDPUBLICATION$$";
					
					//var where = address + ',' + zip + ',' + town + ',' + country;
					var objAddress = {address: address, zip: zip, town: town, country: country, lat: lat, lng: lng,idpub: idpub};
					tabwhere.push(objAddress);
					$$LOOP$$
										
					iCurrentAddress = 0;
					results = new Array();
					FindLoc();
      }
      
      function FindLoc(){
      	try
				{
					 if (iCurrentAddress < tabwhere.length)
					 { 
						 if ((tabwhere[iCurrentAddress].lat != "") && (tabwhere[iCurrentAddress].lng != ""))
						 {
							map.LoadMap(new VELatLong(tabwhere[iCurrentAddress].lat, tabwhere[iCurrentAddress].lng), 15 ,'s' ,false);	
							AddPushpin(new VELatLong(tabwhere[iCurrentAddress].lat, tabwhere[iCurrentAddress].lng), "");
							iCurrentAddress++;
							FindLoc();
						 }
						 else
						 {
						 	 
						   map.Find(null,
											  tabwhere[iCurrentAddress].address + ', ' + tabwhere[iCurrentAddress].zip + ', ' + tabwhere[iCurrentAddress].town + ', ' + tabwhere[iCurrentAddress].country,
											  null,
											  null,
											  index,
											  numResults,
											  true,
											  true,
											  false,
											  false,
											  MoreResults
											  );
								//index = parseInt(index)+9;
							}
						}
						else
						{
							// on va centrer la carte sur les résultats
							map.SetMapView(results);
							document.getElementById("Loader").style.display = "none";
						}
				}
				catch(e){
				   //alert(e.message);
				}
      }
        
     	function MoreResults(layer, resultsArray, places, hasMore, veErrorMessage)
      {
            if(hasMore)
            {
               var r = "<a href='#' onclick=\"javascript:FindLoc();\">" +
                       "Cliquez pour + de résultats</a>";
               
            }
            else
            {
							var infos = "";
							// Précision de la réponse
							if (places[0].MatchConfidence != VEMatchConfidence.High)
							{
								infos = "<p style='text-align:left;font-size:10px;'>Localisation approximative de l'agence :</p>";
							}else{
								//map.SetZoomLevel(18);
							}
							
							AddPushpin(places[0].LatLong, infos);
							index=0;
							number=Number(numResults); 
							//document.getElementById('results').innerHTML = "Pas d'autres résultats disponibles.";
							//document.getElementById("myMap").style.visibility = "visible";
			      }
			      
			      results.push(new VELatLong(places[0].LatLong.Latitude, places[0].LatLong.Longitude));
			      iCurrentAddress++;
			      FindLoc();
      }
         
      function AddPushpin(latlng, infos)
      {
     			
          var shape = new VEShape(VEShapeType.Pushpin, latlng);
         
          //Set the icon
        	shape.SetCustomIcon(icon);
	         if(infos == ""){
			  		shape.SetTitle("<p style='text-align:left;font-size:10px;'>Localisation de l'agence :</p>");
			  	}else{
			  		shape.SetTitle(infos );
			  	}
          shape.SetDescription("<p style='text-align:left;color: Black;font-size:11px;'>" + 'Place Monseigneur Tissier, 1 ter rue Léon Bourgeois'  + '<br/>' + tabwhere[iCurrentAddress].zip + ' ' + tabwhere[iCurrentAddress].town + ' ' + tabwhere[iCurrentAddress].country + '<br/><a href="agence-immobiliere.htm?idp=' + tabwhere[iCurrentAddress].idpub + '&lang=$$FORM:LANG$$" class="LienCartoAgences">$$LG:SAVOIR pcase$$</a></p>');
          map.AddShape(shape);
      }         


	</script>

	<div id="Map" style="position:relative;width:100%;height:100%;">
		<div id="myMap" style="position:relative;width:100%;height:100%;"></div>
		<div id="Loader" style="width:100%;height:100%;position:absolute;top:0;left:0;background:url($$~$$carto/loader.gif) no-repeat center center #FFF;"></div>
	</div>
	<script type="text/javascript">
	window.onload=GetMap;
	</script>
	<!--<div id="results"></div>-->

$$BFIN$$